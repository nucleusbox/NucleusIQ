# Task, Prompt, and Plan: Understanding the Relationship

## Overview

In NucleusIQ, three key concepts work together to define how an agent processes tasks:

1. **Task** - What the user wants done
2. **Prompt** - How the agent should behave
3. **Plan** - How to break down the task (optional)

---

## Definitions

### 1. Task - What to Do

**Purpose:** Represents the user's request or objective.

**Format:**
```python
task: Dict[str, Any] = {
    "id": "task1",                    # Required: Unique identifier
    "objective": "What is 5 + 3?"     # Required: What to accomplish
}
```

**Usage:**
- Passed to `agent.execute(task)`
- The `objective` field contains the actual user request
- Stored in `agent._current_task` during execution

**Example:**
```python
task = {
    "id": "task1",
    "objective": "Calculate 15 + 27 and tell me the weather in Paris"
}
result = await agent.execute(task)
```

---

### 2. Prompt - How to Behave

**Purpose:** Defines the agent's role, instructions, and message formatting.

**Format:**
```python
prompt: Optional[BasePrompt] = None  # Optional: Prompt technique
```

**Usage:**
- Created using `PromptFactory.create_prompt(PromptTechnique.ZERO_SHOT)`
- Configured with `prompt.configure(system="...", user="...")`
- Used to format messages sent to the LLM

**Components:**
- **`prompt.system`**: Agent's role and instructions (e.g., "You are a helpful assistant")
- **`prompt.user`**: Instruction template (optional, e.g., "Answer questions accurately")

**Example:**
```python
prompt = PromptFactory.create_prompt(PromptTechnique.ZERO_SHOT)
prompt.configure(
    system="You are a helpful assistant that performs calculations.",
    user="Answer questions accurately and show your work."
)
agent = Agent(..., prompt=prompt, ...)
```

---

### 3. Plan - How to Break Down (Optional)

**Purpose:** Breaks down complex tasks into smaller, manageable steps.

**Format:**
```python
plan: List[Dict[str, Any]] = [
    {
        "step": 1,
        "action": "execute",  # or tool name
        "task": {...},        # Task or step-specific data
        "details": "..."      # Optional step details
    },
    # ... more steps
]
```

**Usage:**
- Created by `agent.plan(task)` method
- Used automatically if `config.use_planning = True`
- Can be created manually or generated by LLM

**Example:**
```python
# Enable planning
agent = Agent(..., config=AgentConfig(use_planning=True), ...)

# Plan is created automatically in execute()
result = await agent.execute(task)

# Or create plan manually
plan = await agent.plan(task)
```

---

## How They Work Together

### Execution Flow

```
┌─────────────────────────────────────────────────────────────┐
│                    Agent Execution Flow                      │
└─────────────────────────────────────────────────────────────┘

User Input
    ↓
┌─────────────┐
│    Task     │  {"id": "task1", "objective": "What is 5 + 3?"}
└──────┬──────┘
       │
       │ agent.execute(task)
       ↓
┌─────────────────────────────────────────────────────────────┐
│  Step 1: Plan (Optional)                                    │
│  - If config.use_planning = True:                           │
│    plan = await agent.plan(task)                            │
│  - Breaks down complex tasks into steps                     │
└─────────────────────────────────────────────────────────────┘
       │
       ↓
┌─────────────────────────────────────────────────────────────┐
│  Step 2: Build Messages (Uses Prompt + Plan)                │
│  Messages structure:                                         │
│  1. System: prompt.system (Agent's role)                    │
│  2. User: prompt.user (Instruction template, optional)      │
│  3. Plan: Execution plan (if plan has multiple steps)       │
│  4. User: task["objective"] (Actual user request)           │
└─────────────────────────────────────────────────────────────┘
       │
       ↓
┌─────────────────────────────────────────────────────────────┐
│  Step 3: Execute                                            │
│  - If plan has multiple steps: Execute plan steps           │
│  - Otherwise: Execute directly (current behavior)          │
│  - Uses prompt for message formatting                       │
│  - Uses task for actual user request                        │
└─────────────────────────────────────────────────────────────┘
       │
       ↓
┌─────────────┐
│   Result    │  Final answer or execution result
└─────────────┘
```

---

## Message Structure

When the agent calls the LLM, messages are built in this order:

```python
messages = [
    # 1. Agent's role (from prompt.system)
    {"role": "system", "content": "You are a helpful assistant..."},
    
    # 2. Instruction template (from prompt.user, optional)
    {"role": "user", "content": "Answer questions accurately..."},
    
    # 3. Execution plan (if plan exists and has multiple steps)
    {"role": "user", "content": "Execution Plan:\nStep 1: ...\nStep 2: ..."},
    
    # 4. User's actual request (from task["objective"])
    {"role": "user", "content": "What is 5 + 3?"}
]
```

---

## Examples

### Example 1: Simple Execution (No Plan)

```python
# Create prompt
prompt = PromptFactory.create_prompt(PromptTechnique.ZERO_SHOT)
prompt.configure(
    system="You are a helpful assistant.",
    user="Answer questions accurately."
)

# Create agent
agent = Agent(
    name="SimpleAgent",
    role="Assistant",
    objective="Help users",
    narrative="A helpful assistant",
    llm=llm,
    prompt=prompt,
    config=AgentConfig(use_planning=False)  # No planning
)

# Create task
task = {"id": "task1", "objective": "What is 5 + 3?"}

# Execute (no plan, direct execution)
result = await agent.execute(task)
```

**Flow:**
1. Task created
2. No plan (use_planning=False)
3. Messages: [system, user_template, task_objective]
4. Direct execution
5. Return result

---

### Example 2: Execution with Plan

```python
# Create prompt
prompt = PromptFactory.create_prompt(PromptTechnique.ZERO_SHOT)
prompt.configure(
    system="You are a helpful assistant.",
    user="Answer questions accurately."
)

# Create agent with planning enabled
agent = Agent(
    name="PlanningAgent",
    role="Assistant",
    objective="Help users",
    narrative="A helpful assistant",
    llm=llm,
    prompt=prompt,
    config=AgentConfig(use_planning=True)  # Enable planning
)

# Create complex task
task = {
    "id": "task1",
    "objective": "Calculate 15 + 27, then find the weather in Paris"
}

# Execute (plan created automatically)
result = await agent.execute(task)
```

**Flow:**
1. Task created
2. Plan created (use_planning=True)
3. If plan has multiple steps: Execute plan steps
4. If plan has one step: Execute directly
5. Return result

---

### Example 3: Custom Plan

```python
# Create agent
agent = Agent(...)

# Create task
task = {"id": "task1", "objective": "Complex task"}

# Create custom plan manually
plan = [
    {"step": 1, "action": "execute", "task": {"objective": "Step 1"}},
    {"step": 2, "action": "execute", "task": {"objective": "Step 2"}},
]

# Execute with custom plan
result = await agent._execute_plan(task, plan)
```

---

## Key Points

### Task
- ✅ **Always required** - Every execution needs a task
- ✅ **Contains user's request** - The `objective` field is the actual request
- ✅ **Simple format** - Just `id` and `objective` (can have more fields)

### Prompt
- ✅ **Optional but recommended** - Defines agent behavior
- ✅ **Two parts** - `system` (role) and `user` (template)
- ✅ **Affects all executions** - Applied to every task

### Plan
- ✅ **Optional** - Only used if `use_planning=True`
- ✅ **Task decomposition** - Breaks complex tasks into steps
- ✅ **Can be simple or complex** - One step (default) or multiple steps
- ✅ **Integrated into execution** - Used automatically if enabled

---

## When to Use Planning

### ✅ Use Planning When:
- **Complex multi-step tasks** - Tasks that require multiple sequential actions
- **Dynamic planning** - When the plan depends on task content
- **LLM-generated plans** - When you want the LLM to break down tasks intelligently
- **Workflow orchestration** - When coordinating multiple steps

### ❌ Don't Need Planning When:
- **Simple tasks** - Single-step tasks that just need execution
- **Direct execution** - When you just want to execute immediately
- **Tool-based tasks** - When tools handle the complexity

---

## Configuration

### Enable Planning

```python
# Enable planning in agent config
config = AgentConfig(use_planning=True)
agent = Agent(..., config=config, ...)
```

### Disable Planning (Default)

```python
# Planning disabled by default
config = AgentConfig(use_planning=False)  # or omit
agent = Agent(..., config=config, ...)
```

---

## Summary

- **Task** = What the user wants (required)
- **Prompt** = How the agent behaves (optional but recommended)
- **Plan** = How to break down the task (optional, enabled via config)

All three work together:
- Task provides the objective
- Prompt provides the instructions
- Plan provides the decomposition (if enabled)

The agent combines all three to execute tasks effectively!

