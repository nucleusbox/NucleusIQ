name: Publish to PyPI

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:

  # ── Run full CI first ───────────────────────────────────────────────
  ci:
    uses: ./.github/workflows/ci.yml

  # ── Publish core package ────────────────────────────────────────────
  publish-core:
    name: "Publish nucleusiq to PyPI"
    runs-on: ubuntu-latest
    needs: ci
    environment: pypi
    permissions:
      id-token: write

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install build tools
        run: pip install build

      - name: Build package
        working-directory: src/nucleusiq
        run: python -m build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: src/nucleusiq/dist/

  # ── Publish OpenAI provider (after core is live) ────────────────────
  publish-openai:
    name: "Publish nucleusiq-openai to PyPI"
    runs-on: ubuntu-latest
    needs: [ci, publish-core]
    environment: pypi
    permissions:
      id-token: write

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install build tools
        run: pip install build

      - name: Build package
        working-directory: src/providers/llms/openai
        run: python -m build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: src/providers/llms/openai/dist/
